<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura de Datos y Roles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="data_architecture.js"></script>

    <style>
        /* Contenedor principal */
        .mermaid-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            height: 85vh; /* Altura fija */
            width: 100%;
            position: relative; /* Necesario para posicionar elementos absolutos si fuera el caso */
            overflow: hidden; /* Cambiado a hidden para que ECharts maneje el zoom si es necesario */
        }
        
        /* Ajuste para que Mermaid siga centrada y con scroll */
        .mermaid-scroll-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .mermaid-container svg { 
            max-width: 120% !important;
            height: auto !important;
            display: block;
        }


        /* Cursor de mano para todos los nodos */
        g.node { cursor: pointer !important; }
        g.node, g.node > * { transition: all 0.4s ease; }

        /* --- TUS ESTILOS DE MERMAID (Se mantienen igual) --- */
        .glowGreen:hover :is(rect, circle, polygon, path, ellipse) {
            filter: drop-shadow(0 0 10px rgba(76, 175, 80, 0.9)) !important; 
            stroke: #2E7D32 !important; stroke-width: 2px !important;
        }
        .glowYellow:hover :is(rect, circle, polygon, path, ellipse) {
            filter: drop-shadow(0 0 10px rgba(251, 192, 45, 0.9)) !important;
            stroke: #F57F17 !important; stroke-width: 2px !important;
        }
        .glowBlue:hover :is(rect, circle, polygon, path, ellipse) {
            filter: drop-shadow(0 0 10px rgba(33, 150, 243, 0.9)) !important; 
            stroke: #1565C0 !important; stroke-width: 2px !important;
        }
        .glowOrange:hover :is(rect, circle, polygon, path, ellipse) {
            filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.8)) !important; 
            stroke: #FF9800 !important; stroke-width: 3px !important;
        }

        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-100 font-sans text-gray-800">

    <div class="w-full px-8 py-4 min-h-screen flex flex-col">
        
        <header class="text-center mb-4 shrink-0">
            <h1 class="text-3xl font-bold text-slate-800">Mapa de Arquitectura y Roles</h1>
            <p id="instruction-text" class="text-slate-500 mt-2">Navega por el diagrama general y haz clic en los roles para ver sus detalles.</p>
        </header>

        <div id="back-button-container" class="text-center mb-4 hidden">
            <button onclick="renderDiagram('general')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition hover:scale-105 flex items-center mx-auto gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
            </svg>
            Volver al Mapa General
            </button>
        </div>

        <div id="diagram-container" class="mermaid-container">
            </div>

        <div id="legend" class="mt-8 p-4 bg-white rounded shadow border-l-4 border-yellow-400 text-sm text-gray-600 max-w-3xl mx-auto">
            <h3 class="font-bold text-gray-800 mb-1">Guía de Colores:</h3>
            <div class="flex flex-wrap justify-center gap-4">
                <span class="flex items-center"><span class="w-4 h-4 bg-[#FFE0B2] border border-orange-300 mr-2 rounded"></span> Fuentes de Datos</span>
                <span class="flex items-center"><span class="w-4 h-4 bg-[#C8E6C9] border border-green-300 mr-2 rounded"></span> Roles de Análisis</span>
                <span class="flex items-center"><span class="w-4 h-4 bg-[#FFF9C4] border border-yellow-300 mr-2 rounded"></span> Ingeniería</span>
                <span class="flex items-center"><span class="w-4 h-4 bg-[#BBDEFB] border border-blue-300 mr-2 rounded"></span> Plataforma</span>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN MERMAID ---
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true, curve: 'basis', nodeSpacing: 35, rankSpacing: 40, padding: 15 }
        });

        // Variable global para guardar la instancia del gráfico ECharts
        let myChartInstance = null;


        // Función Global para manejar el click
        window.showDetail = function(key) {
            console.log("Mostrando detalle de:", key);
            renderDiagram(key);
        };

        // --- FUNCIÓN RENDERIZADO PRINCIPAL ---
        async function renderDiagram(key) {
            const container = document.getElementById('diagram-container');
            const backBtn = document.getElementById('back-button-container');
            const legend = document.getElementById('legend'); 
            const instruction = document.getElementById('instruction-text');

            // 1. Interfaz
            if (key === 'general') {
                backBtn.classList.add('hidden');
                if(legend) legend.classList.remove('hidden');
                instruction.textContent = 'Navega por el diagrama general y haz clic en los roles para ver sus detalles.';
            } else {
                backBtn.classList.remove('hidden');
                if(legend) legend.classList.add('hidden');
                instruction.textContent = 'Viendo detalles. Haz clic en "Volver" para regresar.';
            }

            // 2. Limpieza previa
            if (myChartInstance) {
                myChartInstance.dispose();
                myChartInstance = null;
            }
            container.innerHTML = ""; // Limpiar cualquier SVG de Mermaid

            // --- CASO A: ECHARTS (FUENTES PRIMARIAS) ---
            if (key === 'fuente_prim') {
                const chartDiv = document.createElement('div');
                chartDiv.style.width = '100%';
                chartDiv.style.height = '100%';
                container.appendChild(chartDiv);
                
                myChartInstance = echarts.init(chartDiv);
                
                const option = {
                title: {
                text: 'Gráfico de Red de Fuentes Primarias',
                left: 'center',
                textStyle: { color: '#333' }
                    },
                tooltip: { trigger: 'item', triggerOn: 'mousemove' },
                series: [{
                    type: 'tree',
                    data: [echartDataFuentes], // Usamos los datos nuevos
                    
                    roam: true, 
                    top: '10%', bottom: '10%', left: '10%', right: '10%',
                    layout: 'radial',
                    symbol: 'circle',
                    symbolSize: 12, 
                    animationDurationUpdate: 500,
                    
                    // Estilos de Etiquetas
                    label: {
                        position: 'top',
                        verticalAlign: 'middle',
                        align: 'center',
                        fontSize: 11,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)', 
                        borderColor: '#ccc',
                        borderWidth: 0,
                        borderRadius: 4,
                        padding: [3, 5],
                        distance: 8
                    },
                    
                    leaves: {
                        label: {
                            position: 'right',
                            verticalAlign: 'middle',
                            align: 'left',
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            padding: [2, 4],
                            borderRadius: 3
                        }
                    },

                    // Énfasis: "Prender" la ruta
                    emphasis: {
                        focus: 'descendant', // IMPORTANTE: Esto apaga lo que no estás tocando
                        blurScope: 'coordinateSystem', 
                        
                        // Al hacer hover en un hijo (tabla), forzamos que brille
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0,0,0,0.5)'
                        },
                        lineStyle: {
                            width: 5 // La línea se hace más gorda al pasar el mouse
                        },
                        label: {
                            fontWeight: 'bold'
                        }
                    }
                }]
            };
                myChartInstance.setOption(option); // Asegúrate que esta variable 'option' exista aquí
                
                window.addEventListener('resize', () => myChartInstance.resize());

            // --- CASO B: ECHARTS (DWH / SANKEY - NUEVO) ---
            } else if (key === 'base_raw') {
                
                const chartDiv = document.createElement('div');
                chartDiv.style.width = '100%';
                chartDiv.style.height = '100%';
                container.appendChild(chartDiv);
                
                myChartInstance = echarts.init(chartDiv);

                const optionSankey = {
                    title: {
                        text: 'Flujo de Consolidación DWH (Raw & Silver)',
                        left: 'center',
                        textStyle: { color: '#333' }
                    },
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove'
                    },
                    series: [{
                        type: 'sankey',
                        data: echartDataDWH.nodes,
                        links: echartDataDWH.links,
                        
                        // Diseño
                        left: '5%', right: '17%', top: '10%', bottom: '10%',
                        nodeWidth: 20,
                        nodeGap: 16,
                        layoutIterations: 32, // Optimiza para que los cruces se vean bonitos
                        
                        // Estilo de los Nodos (Cajitas)
                        itemStyle: {
                            borderWidth: 1,
                            borderColor: '#aaa'
                        },
                        
                        // Estilo de las Líneas (Flujo)
                        lineStyle: {
                            color: 'gradient', // Gradiente automático bonito
                            curveness: 0.5,
                            opacity: 0.4 // Semitransparente para ver cruces
                        },
                        
                        // Etiquetas
                        label: {
                            position: 'right',
                            color: '#000',
                            fontSize: 12,
                            fontWeight: 'bold',
                            formatter: '{b}' // Muestra el nombre
                        },
                        
                        // --- LA MAGIA: ILUMINAR RUTA ---
                        emphasis: {
                            focus: 'adjacency', // Al tocar uno, se iluminan sus padres y sus hijos
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0,0,0,0.5)'
                            },
                            lineStyle: {
                                opacity: 0.8, // La línea se pone sólida
                                width: 3
                            }
                        }
                    }]
                };
                myChartInstance.setOption(optionSankey);
                window.addEventListener('resize', () => myChartInstance.resize());

            // --- CASO C: FLUJO DE CRÉDITOS Y REESTRUCTURAS ---
            } else if (key === 'creditos_flow') {
                
                const chartDiv = document.createElement('div');
                chartDiv.style.width = '100%';
                chartDiv.style.height = '100%';
                container.appendChild(chartDiv);
                
                myChartInstance = echarts.init(chartDiv);

                const optionSankeyCreditos = {
                    title: {
                        text: 'Flujo de Consolidación: Créditos & Reestructuras',
                        subtext: 'Fuente de Verdad vs. Reporte de Inconsistencias',
                        left: 'center',
                        textStyle: { color: '#333', fontSize: 18 }
                    },
                    tooltip: { 
                        trigger: 'item', 
                        triggerOn: 'mousemove',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#333',
                        textStyle: { color: '#000' },
                        // --- AQUÍ ESTÁ LA MAGIA DE LA HISTORIA ---
                        formatter: function (params) {
                            // Si es un NODO (Cajita)
                            if (params.dataType === 'node') {
                                // Buscamos si tiene descripción en los datos
                                const descripcion = params.data.descripcion 
                                    ? `<br/><div style="margin-top:5px; font-size:11px; color:#555; max-width:200px; white-space:normal;">${params.data.descripcion}</div>` 
                                    : '';
                                return `<div style="font-size:14px; font-weight:bold; color:${params.color}">${params.name}</div>${descripcion}`;
                            } 
                            // Si es una LÍNEA (Conexión)
                            else {
                                return `${params.data.source} <br/>  ➡ alimenta a ➡  <br/> ${params.data.target}`;
                            }
                        }
                    },
                    series: [{
                        type: 'sankey',
                        data: echartDataCreditos.nodes,
                        links: echartDataCreditos.links,
                        
                        // Diseño
                        left: '2%', right: '15%', top: '10%', bottom: '5%',
                        nodeWidth: 30,
                        nodeGap: 25,
                        layoutIterations: 0, // Mantiene el orden estricto que definimos
                        
                        itemStyle: { 
                            borderWidth: 1, 
                            borderColor: '#666' 
                        },
                        lineStyle: { 
                            color: 'gradient', 
                            curveness: 0.5, 
                            opacity: 0.4 // Transparencia para limpieza visual
                        },
                        label: {
                            position: 'right',
                            color: '#333',
                            fontSize: 11,
                            fontWeight: '600',
                            formatter: '{b}'
                        },
                        emphasis: {
                            focus: 'adjacency',
                            itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.8)' },
                            lineStyle: { opacity: 0.8, width: 4 }
                        }
                    }]
                };
                myChartInstance.setOption(optionSankeyCreditos);
                window.addEventListener('resize', () => myChartInstance.resize());

            // --- CASO D: MERMAID

            } else {
                // 1. Limpieza: Si había un chart de ECharts, lo destruimos para liberar memoria
                if (myChartInstance) {
                    myChartInstance.dispose();
                    myChartInstance = null;
                }

                // 2. Validación Mermaid
                if (!mermaidDiagrams[key]) {
                    console.error("Diagrama no encontrado:", key);
                    return;
                }

                const definition = mermaidDiagrams[key];
                
                // 3. Loading
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700"></div><p class="mt-2 text-gray-500">Generando gráfico...</p></div>';

                try {
                    await new Promise(r => setTimeout(r, 50));
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    
                    // Render Mermaid
                    const { svg, bindFunctions } = await mermaid.render(id, definition);
                    
                    // Inyectar HTML creando un wrapper para scroll
                    container.innerHTML = `<div class="mermaid-scroll-wrapper">${svg}</div>`;
                    
                    // Funciones post-render (Luces Mermaid)
                    setupGroupHighlight(container); 
                    if (bindFunctions) { bindFunctions(container); }
                    
                } catch (error) {
                    console.error(error);
                    container.innerHTML = `<div class="text-red-600 p-4 border border-red-300 rounded bg-red-50"><strong>Error:</strong> ${error.message}</div>`;
                }

                if(!mermaidDiagrams[key]) return;
                // Loading...
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700"></div></div>';
                
                try {
                    await new Promise(r => setTimeout(r, 50));
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    const { svg, bindFunctions } = await mermaid.render(id, mermaidDiagrams[key]);
                    container.innerHTML = `<div class="mermaid-scroll-wrapper">${svg}</div>`;
                    setupGroupHighlight(container); 
                    if (bindFunctions) bindFunctions(container);
                } catch (error) {
                    console.error(error);
                }
            }
        }
        
        // --- 5. FUNCIONES AUXILIARES (SE MANTIENEN) ---
        function setupGroupHighlight(container) {
            const nodes = container.querySelectorAll('.node');
            const colorMap = {
                'groupCredito': 'glow-blue',
                'groupCRM': 'glow-orange', // Cambié a orange para que combine con CRM
                'groupBase': 'glow-purple',
                'groupApis': 'glow-pink',
                'groupBases': 'glow-purple',
                'groupArchi': 'glow-green'
            };

            nodes.forEach(node => {
                node.classList.forEach(className => {
                    if (colorMap[className]) {
                        const activeColorClass = colorMap[className];
                        node.addEventListener('mouseenter', () => {
                            const related = container.querySelectorAll('.' + className);
                            related.forEach(el => el.classList.add(activeColorClass));
                        });
                        node.addEventListener('mouseleave', () => {
                            const related = container.querySelectorAll('.' + className);
                            related.forEach(el => el.classList.remove(activeColorClass));
                        });
                    }
                });
            });
        }
        
        // Iniciar
        document.addEventListener('DOMContentLoaded', () => {
            renderDiagram('general');
        });
    </script>
</body>
</html>