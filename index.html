<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura de Datos y Roles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Usamos una versión reciente para mejor compatibilidad -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <style>
        /* Contenedor principal */
        .mermaid-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            height: 85vh; /* Altura fija */
            display: grid;
            overflow: auto;
        }
        .mermaid-container svg { 
            margin: auto; max-width: none !important; width: auto !important;
        }

        /* Cursor de mano para todos los nodos */
        g.node { cursor: pointer !important; }
            /*Transción para prender/apagar*/
        g.node, g.node > * {
            transition: all 0.4s ease;
        }

        /* --- 1. BRILLO VERDE (Para Arquitectos, Analistas, Científicos) --- */
        .glowGreen:hover :is(rect, circle, polygon, path, ellipse) {
            filter: drop-shadow(0 0 10px rgba(76, 175, 80, 0.9)) !important; 
            stroke: #2E7D32 !important; /* Borde Verde Oscuro */
            stroke-width: 2px !important;
        }

        /* --- 2. BRILLO AMARILLO (Para Ingenieros, Backend, Frontend) --- */
        .glowYellow:hover :is(rect, circle, polygon, path, ellipse) {
            filter: drop-shadow(0 0 10px rgba(251, 192, 45, 0.9)) !important;
            stroke: #F57F17 !important; /* Borde Naranja/Dorado */
            stroke-width: 2px !important;
        }

        /* --- 3. BRILLO AZUL (Para Plataforma, Cuentas, etc.) --- */
            .glowBlue:hover :is(rect, circle, polygon, path, ellipse) {
                filter: drop-shadow(0 0 10px rgba(33, 150, 243, 0.9)) !important; 
                stroke: #1565C0 !important; stroke-width: 2px !important;
            }

        /* --- LUCES ESPECÍFICAS POR GRUPO --- */
        /* 1. LUZ AZUL (Para Crédito) */
        .glow-blue { filter: drop-shadow(0 0 10px rgba(33, 150, 243, 0.8)) !important; }
        .glow-blue :is(rect, circle, polygon, path, ellipse) {
            stroke: #2196F3 !important; stroke-width: 3px !important; fill: #E3F2FD !important; /* Opcional: El fondo se tiñe un poco de azul muy suave */
        }

        /* 2. LUZ NARANJA (Para CRM/Upnify) */
        .glow-orange { filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.8)) !important; }
        .glow-orange :is(path, rect, circle, ellipse, polygon) {
            stroke: #FF9800 !important; stroke-width: 3px !important; fill: #FFF3E0 !important; /* Fondo suave naranja */
        }

        /* 3. LUZ MORADO (Para Archivos Base) */
        .glow-purple { filter: drop-shadow(0 0 15px rgba(156, 39, 176, 0.9)) !important; }
        .glow-purple :is(path, rect, circle, ellipse, polygon) {
            stroke: #9C27B0 !important; stroke-width: 4px !important; fill: #F3E5F5 !important; /* Fondo morado claro */
        }

        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-100 font-sans text-gray-800">

    <div class="w-full px-8 py-4 min-h-screen flex flex-col">
        
        <header class="text-center mb-4 shrink-0">
            <h1 class="text-3xl font-bold text-slate-800">Mapa de Arquitectura y Roles</h1>
            <p id="instruction-text" class="text-slate-500 mt-2">Navega por el diagrama general y haz clic en los roles para ver sus detalles.</p>
        </header>

    <!-- Botón de Retorno (Solo visible en detalles) -->
        <div id="back-button-container" class="text-center mb-4 hidden">
            <button onclick="renderDiagram('general')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition hover:scale-105 flex items-center mx-auto gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd">
            </svg>
            Volver al Mapa General
            </button>
        </div>

        <!-- Contenedor del Diagrama -->
        <div id="diagram-container" class="mermaid-container">
            <div class="text-gray-400 loading text-xl">Cargando arquitectura...</div>
        </div>

        <!-- Leyenda / Ayuda -->
        <div id="legend" class="mt-8 p-4 bg-white rounded shadow border-l-4 border-yellow-400 text-sm text-gray-600 max-w-3xl mx-auto">
            <h3 class="font-bold text-gray-800 mb-1">Guía de Colores:</h3>
            <div class="flex flex-wrap justify-center gap-4">
                <span class="flex items-center"><span class="w-4 h-4 bg-[#FFE0B2] border border-orange-300 mr-2 rounded"></span> Fuentes de Datos</span>
                <span class="flex items-center"><span class="w-4 h-4 bg-[#C8E6C9] border border-green-300 mr-2 rounded"></span> Roles de Análisis/Exploración</span>
                <span class="flex items-center"><span class="w-4 h-4 bg-[#FFF9C4] border border-yellow-300 mr-2 rounded"></span> Roles de Ingeniería/Integración</span>
                <span class="flex items-center"><span class="w-4 h-4 bg-[#BBDEFB] border border-blue-300 mr-2 rounded"></span> Plataforma y Producción</span>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            securityLevel: 'loose', // Necesario para los clicks
            flowchart: { useMaxWidth: false, htmlLabels: true, curve: 'basis',
            //ESPACIADO: Se aumenta el espacio para que las flechas no crucen las letras 
            nodeSpacing: 35,
            rankSpacing: 40, 
            padding: 15
            }
        });
      
        // INCRUTASCIÓN DE DIAGRAMAS ESPECIFICOS ===        
        const diagrams = {
            // TU DIAGRAMA GENERAL ADAPTADO
            general: `%%{init: {'theme': 'base', 'flowchart': {'useMaxWidth': false, 'nodeSpacing': 30, 'rankSpacing': 45, 'curve': 'basis'}} }%%
                flowchart TB
                
                %% --- DEFINICIÓN DE CLASES POR COLOR ---
                %% 1. Verde (Análisis)
                classDef glowGreen fill:#C8E6C9,stroke:#66BB6A,stroke-width:1px
                %% 2. Amarillo (Ingeniería)
                classDef glowYellow fill:#FFF9C4,stroke:#FDD835,stroke-width:1px
                %% 3. Azul (Plataforma/Cuentas)
                classDef glowBlue fill:#BBDEFB,stroke:#42A5F5,stroke-width:1px
                
                %% --- DEFINICIÓN DE SUBGRAFOS (Áreas) ---
                subgraph SG_Fuente ["FUENTE DE DATOS"]
                    direction TB
                    FP[("Fuentes Primarias")]
                end
                
                subgraph SG_Exploracion ["ROL DE EXPLORACIÓN"]
                    AD(["Arquitecto de Datos"]):::glowGreen
                end
                
                subgraph SG_Principal ["ROL PRINCIPAL"]
                    ID["Ingeniero de Datos"]:::glowYellow
                end
                
                subgraph SG_Plataforma ["PLATAFORMA CENTRAL"]
                    DWH[("Raw & Silver<br/>PostgreSQL")]:::glowBlue
                end
                
                subgraph SG_Trabajo ["ROLES DE EXPLORACIÓN"]
                    AN(["Analista de Datos"]):::glowGreen
                    CD(["Científico de Datos"]):::glowGreen
                end
                
                subgraph STRA ["ROLES DE CONSUMO Y ANÁLISIS "]
                    AND(["Analista de datos"]):::glowGreen
                    CDD(["Científico de datos"]):::glowGreen
                end

                subgraph SG_Integracion ["ROL DE INTEGRACIÓN"]
                    DB["Desarrollador Backend"]:::glowYellow
                end
                
                subgraph SG_Prod_Plat ["PLATAFORMA DE PRODUCCIÓN"]
                    APIS[("API de Producción")]
                end
                
                subgraph SG_Prod_Rol ["ROL DE PRODUCCIÓN"]
                    DF["Desarrollador Frontend"]:::glowYellow
                end
                
                subgraph SG_Web ["PLATAFORMA WEB"]
                    WEB[("Plataforma WEB")]
                end
                
                subgraph SG_Cuentas ["CUENTAS DE SERVICIO"]
                    CUENTA(["Cuenta Externa"]):::glowBlue
                end

                %% --- RELACIONES ---
                FP --> SA(["Acceso: Auditoría"])
                SA ==> ID
                FP -.-> SP(["Acceso: Sólo Lectura"]) 
                SP ==> SG_Exploracion
                AD -.-> ID 
                ID --> PAU(["Acceso Único: Gestión"]) 
                PAU --> SG_Plataforma
                DWH --> SL(["Acceso: Sólo Lectura"])
                SL --> AN
                SL --> CD 
                SL --> SG_Integracion
                
                AN -.-> SG_Integracion
                CD -.-> SG_Integracion
                
                DB --> SG_Prod_Plat
                APIS --> ACCE(["Acceso: Sólo Lectura (Ver Endpoints)"])
                ACCE --> DF 
                APIS --> ACCESO(["Acceso: Push a feature-branch"])
                ACCESO --> STRA
                
                STRA -.-> DF
                DF --> SG_Web
                WEB --> WB(["Acceso: Sólo a la WEB"])
                WB --> SG_Cuentas

                %% --- ESTILOS (COLORES SOLICITADOS) ---
                
                %% Colores de Subgrafos
                style SG_Fuente fill:#FFE0B2,stroke:#FFA726
                style SG_Exploracion fill:#C8E6C9,stroke:#66BB6A
                style SG_Principal fill:#FFF9C4,stroke:#FDD835
                style SG_Plataforma fill:#BBDEFB,stroke:#42A5F5
                style SG_Trabajo fill:#C8E6C9,stroke:#66BB6A
                style STRA fill:#C8E6C9,stroke:#66BB6A
                style SG_Integracion fill:#FFF9C4,stroke:#FDD835
                style SG_Prod_Plat fill:#BBDEFB,stroke:#42A5F5
                style SG_Prod_Rol fill:#FFF9C4,stroke:#FDD835
                style SG_Web fill:#BBDEFB,stroke:#42A5F5
                style SG_Cuentas fill:#C8E6C9,stroke:#66BB6A

                %% Estilos de Nodos (Blancos para resaltar sobre el fondo)
                classDef whiteNode fill:#FFFFFF,stroke:#333,stroke-width:1px;
                class FP,AD,ID,DWH,APIS,WEB,AN,CD,AND,CDD,DB,DF,CUENTA whiteNode;
                
                %% Clase de Acceso
                classDef accessNode fill:#FFCCBC,stroke:#E64A19,stroke-width:2px,color:#000000
                class SA,SP,PAU,SL,ACCE,ACCESO,WB accessNode

                %% Estilos de letras 
                %% color: cambia el texto | stroke: cambia el borde | fill: cambia el fondo
                style FP fill:#FFFFFF,stroke:#E65100,stroke-width:2px,color:#D84315,font-weight:bold
                %% Estilo para plataformas 
                style DWH fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
                style APIS fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
                style WEB fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold

                %% --- INTERACTIVIDAD (CLICKS) ---
                %% Aquí conectamos tus nodos con los detalles
                
                click ID call showDetail("ingeniero") "Ver detalle Ingeniero de Datos"
                click AD call showDetail("arquitecto") "Ver detalle Arquitecto"
                click AN call showDetail("analista") "Ver detalle Analista"
                click CD call showDetail("cientifico") "Ver detalle Científico"
                click DB call showDetail("backend") "Ver detalle Backend"
                click DF call showDetail("frontend") "Ver detalle Frontend"
                click AND call showDetail("analist") "Ver detalle Analista"
                click CDD call showDetail("cientifi") "Ver detalle Cientifico"
                click CUENTA call showDetail("cuenta") "Ver detalle Cuenta"
                click DWH call showDetail("base_raw") "Ver detalle Base Raw"
            `,

            // --- DIAGRAMAS DE DETALLE ---
            // 2. DIAGRAMA: INGENIERO DE DATOS (Permisos y Tareas)
            ingeniero: `
                graph LR
                title[Rol: INGENIERO DE DATOS]
                style title fill:#FFF9C4,stroke:none
                
                User((Ingeniero))
                
                subgraph FUENTE DE DATOS
                    %% ROMBO 
                    FP[("Fuentes Primarias")]
                end

                subgraph PLATAFORMA CENTRAL
                    %% CILINDRO
                    DWH[("Raw & Silver")]
                end
           
                subgraph Tareas
                    T1[Ingesta de Fuentes]
                    T2[Ejecuta Scripts]
                    T3[Le da mantenimiento al DWH]
                    T4[Define modelos Silver & Golden]
                    T5[Ejecuta scripts de consolidación]
                end
                
                subgraph Permisos ["Permisos"]
                    P1[AUDITORIA]
                    P2[CREA/ACTUALIZA]
                end
                
                FP --> Permisos
                Permisos --> User 
                User --> T1 & T2 & T3 & T4 & T5
                T4 -.-> DWH 
                T5 -.-> DWH 
                
                style User fill:#FFF9C4,stroke:#FBC02D
                style FP fill:#FFFFFF,stroke:#E65100,stroke-width:2px,color:#D84315,font-weight:bold
                style DWH fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,
            
            // 3. DIAGRAMA: ARQUITECTO (Permisos y Tareas)
            arquitecto: `
                graph LR
                title[Rol: ARQUITECTO DE DATOS]
                style title fill:#C8E6C9,stroke:none
                
                User((Arquitecto))
                
                subgraph FUENTE DE DATOS
                    %% ROMBO 
                    FP[("Fuentes Primarias")]
                end

                subgraph Tareas
                    T1[Feedback Estructura]
                    T2[Exploración]
                    T3[Audita y propone mejoras al Ingeniero de datos]
                    T4[Sugiere reglas de negocio para Silver]
                end
                
                subgraph Permisos ["Permisos Generales"]
                    P1[VISTA DE METADATA]
                    P2[NO TIENE ACCESO DE ESCRITURA]
                end

                subgraph PLATAFORMA CENTRAL
                    %% CILINDRO
                    DWH[("Raw & Silver")]
                end
                
                %% Relaciones
                FP --> P1
                Permisos --> User
                User --> T1 & T2 & T3 & T4
                T4 -.-> DWH
        
                %% Estilos
                style User fill:#C8E6C9,stroke:#43A047
                style FP fill:#FFFFFF,stroke:#E65100,stroke-width:2px,color:#D84315,font-weight:bold
                style DWH fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,

            // 4. DIAGRAMA: ANALISTA (Permisos y Tareas)
            analista: `
                graph LR
                title[Rol: ANALISTA DE DATOS]
                style title fill:#C8E6C9,stroke:none
                
                User((Analista))

                subgraph PLATAFORMA CENTRAL
                    %% CILINDRO
                    DWH[("Raw & Silver")]
                end
                
                subgraph Tareas
                    T1[Realiza reportes de la base Silver]
                    T2[Diseña y crea Dashboards]
                    T3[Elabora análisis de KPI]
                    T4[Prueba y valida las variables y métricas del SQL]
                    T5[Realiza sugerencias al Desarrollador Backend]
                end
                
                subgraph Permisos ["Permisos DWH"]
                    P1[SÓLO LECTURA/VISUALIZACIÓN]
                end
                
                DWH --> P1
                P1 --> User 
                User --> T1 & T2 & T3 & T4 & T5
                
                style User fill:#C8E6C9,stroke:#43A047
                style DWH fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,
            
            // 5. DIAGRAMA: CIENTÍFICO (Permisos y Tareas)
            cientifico: `
                graph LR
                title[Rol: CIENTÍFICO DE DATOS]
                style title fill:#C8E6C9,stroke:none
                
                User((Científico))

                subgraph PLATAFORMA CENTRAL
                    %% CILINDRO
                    DWH[("Raw & Silver")]
                end
                
                subgraph Tareas
                    T1[Prueba algoritmos]
                    T2[Realiza modelado de datos]
                    T3[Diseña experimentos-A/B Testing]
                    T4[Valida métricas clave de negocio]
                    T5[Feedback al Desarrollador Backend]

                end
                
                subgraph Permisos ["Permisos DWH"]
                    P1[SOLO LECTURA/VISUALIZACIÓN]
                end
                
                DWH --> P1
                P1 --> User
                User --> T1 & T2 & T3 & T4 & T5
                style User fill:#C8E6C9,stroke:#43A047
                style DWH fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,
            
            // 6. DIAGRAMA: BACKEND (Permisos y Tareas)
            backend: `
                graph LR
                title[Rol: DESARROLLADOR BACKEND]
                style title fill:#FFF9C4,stroke:none
                
                User((Backend Dev))
        
                subgraph SG_PLATAFORMA ["PLATAFORMA CENTRAL"]
                    %% CILINDRO
                    DWH[("Raw & Silver")]
                end
                
                subgraph Permiso ["Permisos"]
                    P1[SÓLO LECTURA]
                end 

                subgraph Tareas_Silver ["Tareas"]
                    T1[Configura y Crea]
                end

                subgraph PLATAFORMA DE PRODUCCIÓN 
                    %%Cilindro 
                    APIS[("API de Producción")]
                end

                subgraph Tareas API
                    Y1[Crear Endpoints]
                    Y2[Implenta Tokens]
                    Y3[Mantiene y monitorea la API]
                    Y4[Estandariza salidas]
                    Y5[Gestiona diferentes entornos]
                end
                
                subgraph Permisos ["Permisos"]
                    J1[DEPLOY]
                    J2[PUSH A MAIN]
                end
                
                %% Relaciones
                DWH --> Permiso
                Permiso --> User
                User --> T1 
                T1 --> APIS
                APIS --> Permisos
                Permisos --> Y1 & Y2 & Y3 & Y4 & Y5

                style User fill:#FFF9C4,stroke:#FBC02D
                style DWH fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
                style APIS fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,
            
            // 7. DIAGRAMA: FRONTEND (Permisos y Tareas)
            frontend: `
                graph LR
                title[Rol: DESARROLLADOR FRONTEND]
                style title fill:#FFF9C4,stroke:none
                
                User((Frontend Dev))

                subgraph PLATAFORMA DE PRODUCCIÓN 
                    %%Cilindro 
                    APIS[("API de Producción")]
                end

                subgraph Permiso ["Permisos"]
                    P1[SÓLO LECTURA: VER ENDPOINTS]
                end
                
                subgraph Tarea
                    T1[Revisa la documentación de la API]
                    T2[Conecta los componentes de la UI]
                    T3[Construye UI]
                end
                
                subgraph SG_Web ["PLATAFORMA WEB"]
                    WEB[("Plataforma WEB")]
                end
                
                subgraph Permisos ["Permisos"]
                    J1[CONSUME & GESTIONA]
                end

                subgraph Tareas ["Tareas"]
                    Y1[Desarrolla tableros en React/Dash]
                    Y2[Publica en la plataforma]
                end
                
                APIS --> P1
                P1 --> User 
                User --> T1 & T2 & T3
                T3 -.-> WEB
                WEB --> J1
                J1 --> Y1 & Y2
                style User fill:#FFF9C4,stroke:#FBC02D
                style APIS fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
                style WEB fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,

            //8. DIAGRAMA: Analista de datos 
            analist: `
                graph LR
                title[Rol: Analista de datos]
                style title fill:#FFF9C4,stroke:none
                
                User((Analista))

                subgraph PLATAFORMA DE PRODUCCIÓN 
                    %%Cilindro 
                    APIS[("API de Producción")]
                end
                
                subgraph Permiso ["Permisos"]
                    P1["PUSH A FEATURE-BRANCH"]
                end
                
                subgraph Tareas
                    T1[Revisa que los endpoints sean consistentes]
                    T2[Genera reportes preeliminares]
                    T3[Verifica que los endpoints sean lógicos y fáciles de entender para otros consumidores]
                    T4[Propone la creación o modificación de APIs al Backend]
                end
                
                APIS --> P1
                P1 --> User
                User --> T1 & T2 & T3 & T4
                style User fill:#C8E6C9,stroke:#43A047
                style APIS fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,

            //9. DIAGRAMA: Científico de datos 
            cientifi: `
                graph LR
                title[Rol: Científico de datos]
                style title fill:#FFF9C4,stroke:none
                
                User((Cientifico))

                subgraph PLATAFORMA DE PRODUCCIÓN 
                    %%Cilindro 
                    APIS[("API de Producción")]
                end
                
                subgraph Permiso ["Permisos"]
                    P1["PUSH A FEATURE-BRANCH"]
                end
                
                subgraph Tareas
                    T1[Realiza simulaciones con las versiones piloto]
                    T2[Prueba las APIs para medir la latencia al solicitar grandes volúmenes de datos]
                    T3[Genera modelos de similitud y evaluación]
                    T4[Feedback detallado al Desarrollador Backend]
                end
                
                APIS --> P1
                P1 --> User
                User --> T1 & T2 & T3 & T4
                style User fill:#C8E6C9,stroke:#43A047
                style APIS fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,

            //10. DIAGRAMA CUENTA EXTERNA
            cuenta:  `
                graph LR
                title[Rol: Cuenta Externa]
                style title fill:#FFF9C4,stroke:none
                
                User((Cuenta))

                subgraph SG_Web ["PLATAFORMA WEB"]
                    WEB[("Plataforma WEB")]
                end
                
                subgraph Permiso ["Permisos"]
                    P1["SÓLO LECTURA"]
                end
                
                subgraph Tareas
                    T1[Visualiza la plataforma WEB]
                    T2[Realiza comentarios a los desarrolladores]
                    T3[Utiliza la plataforma para consumo propio]
                end
               
                WEB --> P1
                P1 --> User 
                User --> T1 & T2 & T3
                style User fill:#C8E6C9,stroke:#43A047
                style WEB fill:#FFFFFF,stroke:#1565C0,stroke-width:2px,color:#0D47A1,font-weight:bold
            `,

            //DIAGRAMA DE FUENTES 
            base_raw: `%%{init: {
                'theme': 'base', 
                'flowchart': {
                    'nodeSpacing': 40, 
                    'rankSpacing': 80, 
                    'curve': 'step', 
                    'padding': 25
                }
            } }%%
                flowchart TD
                
                %% CLASES (Se mantienen igual)
                classDef groupBase opacity:1
                classDef groupCredito opacity:1
                classDef groupCRM opacity:1
                
                %% --- DEFINICIÓN DE SUBGRAFOS ---
                
                subgraph P1 ["Paso 1: Inicialización"]
                    direction TB
                    A[("Archivos Auxiliares<br/>(Excel/CSV)")]:::groupBase
                    B[("Carga: raw.geo_*<br/>raw.inventario")]:::groupBase
                end
                
                subgraph P2 ["Paso 2: Ingesta de Datos Maestros"]
                    direction TB
                    C1[("raw.creditos_as")]:::groupCredito
                    C2[("raw.upnify_prospectos")]:::groupCRM
                    C3[("raw.upnify_oportunidades")]:::groupCRM
                    C4[("raw.upnify_ventas")]:::groupCRM
                    C5[("raw.upnify_productos")]:::groupCRM
                end
                
                subgraph P3 ["Paso 3: Detalle y dependencias del crédito"]
                    direction TB
                    D1[("raw.bitacora_judicial")]:::groupCredito
                    D2[("raw.creditos_historica")]:::groupCredito
                end
                
                subgraph P4 ["Paso 4: Detalle y detalle CRM"]
                    direction TB
                    E1[("raw.upnify_seguimientos")]:::groupCRM
                    E2[("raw.upnify_prod_oportunidades")]:::groupCRM
                end
                
                subgraph P5 ["Paso 5: Reconstrucción Histórica"]
                    direction TB
                    F[("raw.reportes_mora21")]:::groupCredito
                end

                %% --- RELACIONES (Conexiones limpias) ---
                A --> B
                B --> C1
                B --> C2 & C3 & C4 & C5
                C1 --> D1
                C1 --> D2
                D1 & D2 --> F
                C2 --> E1
                C3 --> E1 & E2

                %% --- ESTILOS VISUALES MEJORADOS ---
                
                %% Nodos neutros (Blancos con borde gris suave)
                classDef neutral fill:#FFFFFF,stroke:#B0BEC5,stroke-width:1px,color:#37474F
                class A,B,C1,C2,C3,C4,C5,D1,D2,E1,E2,F neutral

                %% ESTILOS DE LOS CUADROS (Pasteles + Bordes Redondeados)
                %% rx:5,ry:5 redondea las esquinas.
                
                %% P1: Gris azulado muy tenue (Neutro)
                style P1 fill:#F5F7F8,stroke:#CFD8DC,stroke-width:2px,stroke-dasharray: 5 5,rx:5,ry:5
                
                %% P2: Azul cian muy pálido (Datos Maestros / Fresco)
                style P2 fill:#E0F7FA,stroke:#80DEEA,stroke-width:2px,stroke-dasharray: 5 5,rx:5,ry:5
                
                %% P3: Índigo lavanda muy suave (Crédito / Serio)
                style P3 fill:#E8EAF6,stroke:#9FA8DA,stroke-width:2px,stroke-dasharray: 5 5,rx:5,ry:5
                
                %% P4: Naranja crema muy suave (CRM / Cálido)
                style P4 fill:#FFF3E0,stroke:#FFCC80,stroke-width:2px,stroke-dasharray: 5 5,rx:5,ry:5
                
                %% P5: Verde lima muy pálido (Histórico / Finalización)
                style P5 fill:#F1F8E9,stroke:#C5E1A5,stroke-width:2px,stroke-dasharray: 5 5,rx:5,ry:5
            `,
        }

        // Función Global para manejar el click
        window.showDetail = function(key) {
            console.log("Mostrando detalle de:", key);
            renderDiagram(key);
        };

        // Función para activar el iluminado en grupo
        function setupGroupHighlight(container) {
            // 1. Buscamos todos los nodos en el diagrama actual
            const nodes = container.querySelectorAll('.node');

            //Mapa de colores: depende de la fuente de datos 
            const colorMap = {
                'groupCredito': 'glow-blue',
                'groupCRM': 'glow-orange',
                'groupBase': 'glow-purple'
            };

            nodes.forEach(node => {
                // 2. Revisamos las clases de cada nodo
                node.classList.forEach(className => {
                    // 3. Si la clase empieza con 'group' (ej: groupVentas)
                    if (colorMap[className]) {
                        const activeColorClass = colorMap[className];
                        
                        // EVENTO MOUSE OVER (Entrar)
                        node.addEventListener('mouseenter', () => {
                            // Buscar TODOS los elementos con esa misma clase
                            const related = container.querySelectorAll('.' + className);
                            related.forEach(el => {
                                // Forzamos el brillo añadiendo la clase CSS del Paso 1
                                el.classList.add(activeColorClass);
                            });
                        });

                        // EVENTO MOUSE OUT (Salir)
                        node.addEventListener('mouseleave', () => {
                            const related = container.querySelectorAll('.' + className);
                            related.forEach(el => {
                                el.classList.remove(activeColorClass);
                            });
                        });
                    }
                });
            });
        }
        // Función de renderizado
        async function renderDiagram(key) {
            const container = document.getElementById('diagram-container');
            const backBtn = document.getElementById('back-button-container');
            const legend = document.getElementById('legend'); // Ahora esto funcionará porque pusimos el ID en el HTML
            const instruction = document.getElementById('instruction-text');

            // Validación de seguridad por si la llave no existe
            if (!diagrams[key]) {
                console.error("Diagrama no encontrado:", key);
                return;
            }

            // Definimos 
            const definition = diagrams[key];

            // Lógica de interfaz (Mostrar/Ocultar botón de regreso)
            if (key === 'general') {
                backBtn.classList.add('hidden');
                if(legend) legend.classList.remove('hidden'); // Check de seguridad
                instruction.textContent = 'Navega por el diagrama general y haz clic en los roles para ver sus detalles.';
            } else {
                backBtn.classList.remove('hidden');
                if(legend) legend.classList.add('hidden'); // Check de seguridad
                instruction.textContent = 'Viendo detalles del rol. Haz clic en "Volver" para regresar.';
            }

            // Feedback visual de carga
            container.innerHTML = '<div class="flex flex-col items-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700"></div><p class="mt-2 text-gray-500">Generando gráfico...</p></div>';

            try {
                // Esperamos un poco para que el DOM respire
                await new Promise(r => setTimeout(r, 50));
                
                // Generar ID único para evitar conflictos de caché de Mermaid
                const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                // Renderizar (Ahora 'definition' ya existe)
                const { svg, bindFunctions } = await mermaid.render(id, definition);
                //1. Inserta el SVG
                container.innerHTML = svg;
                //2. Se activan las luces del SVG 
                setupGroupHighlight(container); 
                //3. Vinculamos los clicks
                if (bindFunctions) {
                    bindFunctions(container);
                }
                
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="text-red-600 p-4 border border-red-300 rounded bg-red-50">
                    <strong>Error de renderizado:</strong><br/>${error.message}
                </div>`;
            }
        }   
        
        // Iniciar con el diagrama general
        document.addEventListener('DOMContentLoaded', () => {
            renderDiagram('general');
        });
    </script>
</body>
</html>